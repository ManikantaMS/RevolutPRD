<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Revolut Customer Support</title>
  <style>
    :root {
      --primary-bg: #f8fafc;
      --primary-txt: #1a202c;
      --accent: #2563eb;
      --accent-light: #60a5fa;
      --calm-bg: #e3f6f5;
      --calm-txt: #22223b;
      --human-btn: #2563eb;
      --human-btn-hover: #1d4ed8;
      --human-btn-txt: #fff;
      --danger: #b91c1c;
      --success: #059669;
      --font-size: 18pt;
      --font-size-lg: 24pt;
      --border-radius: 18px;
      --border-radius-sm: 12px;
      --shadow: 0 8px 24px rgba(0,0,0,0.08);
      --shadow-sm: 0 4px 12px rgba(0,0,0,0.05);
      --avatar-size: 48px;
      --focus-outline: 3px solid #ffb703;
      --calm-shadow: 0 0 0 4px #e3f6f5;
      --transition: all 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(37,99,235,0.4); }
      70% { box-shadow: 0 0 0 10px rgba(37,99,235,0); }
      100% { box-shadow: 0 0 0 0 rgba(37,99,235,0); }
    }

    body {
      background: var(--primary-bg);
      color: var(--primary-txt);
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      font-size: var(--font-size);
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      background-image: 
        radial-gradient(circle at 90% 10%, rgba(227, 246, 245, 0.4) 0%, transparent 70%),
        radial-gradient(circle at 10% 90%, rgba(224, 231, 239, 0.4) 0%, transparent 70%);
      line-height: 1.6;
    }
    .calm-mode {
      background: var(--calm-bg);
      color: var(--calm-txt);
      font-size: var(--font-size-lg);
      box-shadow: var(--calm-shadow);
    }
    .support-container {
      width: 100%;
      max-width: 580px;
      margin: 2rem auto;
      background: #fff;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 2.5rem 2rem 5rem 2rem;
      position: relative;
      transition: var(--transition);
      animation: fadeIn 0.5s ease-out;
    }
    /* Add improved UI layering */
    .support-container {
      position: relative;
      z-index: 1;
    }
    
    .feedback-modal {
      z-index: 2000;
    }
    
    .agent-banner {
      position: sticky;
      top: 0;
      z-index: 100;
      background: white;
      border-bottom: 1px solid #e2e8f0;
      margin-bottom: 1rem;
      padding: 0.5rem;
    }
    
    .always-human {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
    }
    
    .chat-log {
      position: relative;
      z-index: 1;
      overflow-y: auto;
      max-height: calc(100vh - 300px);
      padding: 1rem;
      margin: 1rem 0;
    }
    
    #namePrompt {
      z-index: 1500;
      background: white;
      padding: 2rem;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
    }
    
    .call-back {
      margin-top: 1rem;
      padding: 1rem;
      background: #f8fafc;
      border-radius: var(--border-radius);
    }
    .always-human {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      background: var(--human-btn);
      color: var(--human-btn-txt);
      font-size: var(--font-size);
      border: none;
      border-radius: 50px;
      padding: 1.2rem 2.8rem;
      box-shadow: var(--shadow);
      cursor: pointer;
      z-index: 1000;
      transition: var(--transition);
      font-weight: bold;
      letter-spacing: 0.5px;
      animation: pulse 2s infinite;
    }
    .always-human:hover {
      background: var(--human-btn-hover);
      transform: translateY(-2px);
      box-shadow: 0 12px 28px rgba(37,99,235,0.2);
    }
    .progress {
      font-size: 1.2rem;
      color: var(--accent);
      margin-bottom: 1.5rem;
      font-weight: bold;
      letter-spacing: 0.5px;
      text-align: center;
      padding: 0.5rem 1rem;
      background: rgba(37,99,235,0.05);
      border-radius: var(--border-radius-sm);
    }
    .agent-banner {
      display: flex;
      align-items: center;
      gap: 1.2rem;
      background: linear-gradient(to right, #e3f6f5, #f0f9ff);
      border-radius: var(--border-radius);
      padding: 1.2rem 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow-sm);
      font-size: 1.1rem;
      color: var(--accent);
      font-weight: 500;
      min-height: 64px;
      animation: fadeIn 0.5s ease-out;
      border: 1px solid rgba(37,99,235,0.1);
    }
    .agent-avatar {
      width: var(--avatar-size);
      height: var(--avatar-size);
      border-radius: 50%;
      background: #fff;
      border: 2px solid var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      font-weight: bold;
      color: var(--accent);
      box-shadow: var(--shadow-sm);
      transition: var(--transition);
    }
    .chat-log {
      min-height: 200px;
      max-height: 320px;
      overflow-y: auto;
      margin-bottom: 1.2rem;
      border-radius: var(--border-radius);
      background: #f8fafc;
      padding: 1.2rem;
      font-size: 1.1rem;
      border: 1px solid rgba(37,99,235,0.1);
      scroll-behavior: smooth;
    }
    .chat-entry {
      margin-bottom: 1rem;
      line-height: 1.6;
      padding: 0.8rem 1.2rem;
      border-radius: var(--border-radius-sm);
      animation: fadeIn 0.3s ease-out;
      max-width: 85%;
    }
    .chat-entry.agent {
      color: var(--accent);
      font-weight: 500;
      background: rgba(37,99,235,0.05);
      margin-right: auto;
    }
    .chat-entry.user {
      background: var(--accent);
      color: white;
      margin-left: auto;
    }
    .chat-entry.escalated {
      color: var(--danger);
      font-weight: bold;
      background: #fff0f0;
      border-radius: var(--border-radius-sm);
      padding: 1rem 1.2rem;
      border-left: 4px solid var(--danger);
      max-width: 100%;
    }
    #namePrompt {
      background: white;
      padding: 2rem;
      border-radius: var(--border-radius);
      text-align: center;
      box-shadow: var(--shadow);
      animation: fadeIn 0.5s ease-out;
    }
    #namePrompt label {
      font-size: 1.3rem;
      color: var(--accent);
      margin-bottom: 1.5rem;
      display: block;
    }
    #namePrompt .input-row {
      max-width: 400px;
      margin: 1.5rem auto;
    }
    #namePrompt input {
      font-size: 1.2rem;
      padding: 0.8rem 1.2rem;
    }
    #namePrompt button {
      font-size: 1.2rem;
      padding: 0.8rem 1.5rem;
      transition: var(--transition);
    }
    #namePrompt button:hover {
      background: var(--human-btn-hover);
      transform: translateY(-2px);
    }
    .input-row {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .input-row input, .input-row textarea {
      flex: 1;
      font-size: var(--font-size);
      border-radius: var(--border-radius);
      border: 2px solid #cbd5e1;
      padding: 0.5rem 1rem;
      background: #f8fafc;
      transition: border 0.2s;
    }
    .input-row input:focus, .input-row textarea:focus {
      border: 2px solid #2563eb;
      outline: var(--focus-outline);
    }
    .input-row button {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: var(--border-radius);
      font-size: var(--font-size);
      padding: 0.5rem 1.5rem;
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(37,99,235,0.08);
    }
    .input-row button:focus {
      outline: var(--focus-outline);
    }
    .audit-trail {
      font-size: 1rem;
      background: #f8fafc;
      border-radius: var(--border-radius);
      padding: 1rem;
      margin-top: 1.5rem;
      box-shadow: var(--shadow);
      color: #22223b;
    }
    .glossary {
      border-bottom: 2px dotted var(--accent);
      cursor: help;
      position: relative;
      color: #2563eb;
      font-weight: 500;
      padding-right: 1.2em;
    }
    .glossary:after {
      content: "?";
      font-size: 0.9em;
      color: #2563eb;
      background: #e3f6f5;
      border-radius: 50%;
      padding: 0.1em 0.4em;
      margin-left: 0.2em;
      vertical-align: middle;
      font-weight: bold;
    }
    .glossary-tooltip {
      display: none;
      position: absolute;
      left: 0;
      top: 2.2em;
      background: #fff;
      color: #22223b;
      border: 2px solid #2563eb;
      border-radius: 10px;
      padding: 0.7em 1.2em;
      font-size: 1rem;
      z-index: 10;
      min-width: 200px;
      box-shadow: 0 2px 8px rgba(37,99,235,0.08);
    }
    .glossary:hover .glossary-tooltip, .glossary:focus .glossary-tooltip {
      display: block;
    }
    .calm-toggle {
      position: absolute;
      top: 1.5rem;
      right: 1.5rem;
      background: #e0e7ef;
      color: #22223b;
      border: none;
      border-radius: 50px;
      font-size: 1.1rem;
      padding: 0.7rem 1.5rem;
      cursor: pointer;
      box-shadow: var(--shadow);
      font-weight: bold;
      letter-spacing: 0.5px;
      transition: background 0.2s;
    }
    .calm-toggle:focus {
      outline: var(--focus-outline);
    }
    .call-back {
      margin: 1.2rem 0;
      padding: 1.2rem;
      background: #f1f5f9;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(37,99,235,0.08);
    }
    .call-back label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    .call-back select {
      font-size: 1.1rem;
      border-radius: 10px;
      padding: 0.3rem 1rem;
      margin-bottom: 0.5rem;
      border: 2px solid #cbd5e1;
      background: #fff;
      transition: border 0.2s;
    }
    .call-back select:focus {
      border: 2px solid #2563eb;
      outline: var(--focus-outline);
    }
    .call-back button {
      margin-top: 0.5rem;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 1.1rem;
      padding: 0.5rem 1.5rem;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(37,99,235,0.08);
      transition: background 0.2s;
    }
    .call-back button:focus {
      outline: var(--focus-outline);
    }
    .callback-options {
      margin-top: 1.2rem;
      background: white;
      padding: 1.5rem;
      border-radius: var(--border-radius-sm);
      border: 1px solid rgba(37,99,235,0.1);
    }
    .instant-call {
      width: 100%;
      background: var(--success);
      color: white;
      border: none;
      border-radius: var(--border-radius-sm);
      font-size: 1.2rem;
      padding: 1rem 2rem;
      cursor: pointer;
      font-weight: bold;
      margin-bottom: 1.2rem;
      transition: var(--transition);
      box-shadow: var(--shadow-sm);
    }
    .instant-call:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(5,150,105,0.2);
    }
    .or-divider {
      text-align: center;
      margin: 1.2rem 0;
      color: #64748b;
      font-weight: 500;
      position: relative;
    }
    .or-divider::before,
    .or-divider::after {
      content: '';
      position: absolute;
      top: 50%;
      width: 45%;
      height: 1px;
      background: rgba(100,116,139,0.2);
    }
    .or-divider::before { left: 0; }
    .or-divider::after { right: 0; }
    .callback-note {
      margin-top: 1.2rem;
      font-size: 1rem;
      color: #64748b;
      padding: 0.8rem 1rem;
      background: rgba(100,116,139,0.05);
      border-radius: var(--border-radius-sm);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .callback-note::before {
      content: '🔒';
      font-size: 1.2rem;
    }
    .export-button {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      background: white;
      color: var(--accent);
      border: 1px solid rgba(37,99,235,0.2);
      border-radius: var(--border-radius-sm);
      padding: 0.8rem 1.2rem;
      font-size: 1rem;
      cursor: pointer;
      margin-top: 1rem;
      transition: var(--transition);
      font-weight: 500;
    }
    .export-button:hover {
      background: rgba(37,99,235,0.05);
      border-color: var(--accent);
    }
    .exit-chat {
      position: absolute;
      top: 1.5rem;
      left: 1.5rem;
      background: #f1f5f9;
      color: #64748b;
      border: none;
      border-radius: 50px;
      font-size: 1.1rem;
      padding: 0.7rem 1.5rem;
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      font-weight: 500;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .exit-chat:hover {
      background: #e2e8f0;
      color: var(--danger);
    }

    .feedback-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease-out;
    }

    .feedback-content {
      background: white;
      padding: 2rem;
      border-radius: var(--border-radius);
      width: 90%;
      max-width: 500px;
      box-shadow: var(--shadow);
    }

    .feedback-content h2 {
      margin-top: 0;
      color: var(--accent);
    }

    .rating-buttons {
      display: flex;
      gap: 1rem;
      margin: 1.5rem 0;
      justify-content: center;
    }

    .rating-btn {
      border: none;
      background: #f1f5f9;
      padding: 1rem;
      border-radius: 50%;
      cursor: pointer;
      transition: var(--transition);
      font-size: 1.5rem;
    }

    .rating-btn:hover {
      transform: scale(1.1);
      background: #e2e8f0;
    }

    .email-input {
      width: 100%;
      margin: 1rem 0;
      padding: 0.8rem;
      border: 2px solid #cbd5e1;
      border-radius: var(--border-radius-sm);
      font-size: 1rem;
    }

    .feedback-actions {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .feedback-actions button {
      flex: 1;
      padding: 0.8rem;
      border: none;
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      font-weight: 500;
      transition: var(--transition);
    }

    .submit-feedback {
      background: var(--accent);
      color: white;
    }

    .cancel-feedback {
      background: #f1f5f9;
      color: #64748b;
    }
    @media (max-width: 600px) {
      .support-container {
        padding: 1rem 0.5rem 5rem 0.5rem;
      }
      .always-human {
        right: 0.5rem;
        left: 0.5rem;
        width: calc(100vw - 1rem);
        border-radius: 20px;
      }
    }

    /* Add confirmation styling */
    .chat-entry.isConfirmation {
      background: #f0fdf4;
      color: var(--success);
      border-left: 4px solid var(--success);
      font-weight: 500;
      max-width: 100%;
      margin-bottom: 1rem;
    }

    .ticket-number {
      background: #f8fafc;
      padding: 0.8rem;
      border-radius: var(--border-radius-sm);
      margin: 1rem 0;
      font-family: monospace;
      text-align: center;
      color: var(--accent);
    }

    .start-new-chat {
      background: var(--accent);
      color: white;
      padding: 0.8rem 1.5rem;
      border: none;
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      font-weight: 500;
      transition: var(--transition);
    }

    .start-new-chat:hover {
      transform: scale(1.05);
    }
  </style>
</head>
<body>
  <div class="support-container" id="supportContainer">
    <button class="calm-toggle" id="calmToggle" aria-label="Toggle Calm Mode">Calm Mode</button>
    <div class="progress" id="progress">Welcome to Revolut Customer Support</div>

    <div class="feedback-modal" id="feedbackModal">
      <div class="feedback-content">
        <h2>Before You Go</h2>
        <p>How was your experience with our support today?</p>
        <div class="rating-buttons">
          <button class="rating-btn" data-rating="1">😞</button>
          <button class="rating-btn" data-rating="2">😐</button>
          <button class="rating-btn" data-rating="3">🙂</button>
          <button class="rating-btn" data-rating="4">😊</button>
          <button class="rating-btn" data-rating="5">😍</button>
        </div>
        <p>Would you like a copy of your chat history and acknowledgment ticket?</p>
        <input type="email" class="email-input" id="emailInput" placeholder="Enter your email (optional)" />
        <div class="ticket-number"></div>
        <div class="feedback-actions">
          <button class="cancel-feedback" id="cancelFeedback">Continue Chat</button>
          <button class="submit-feedback" id="submitFeedback">Submit & End Chat</button>
        </div>
        <div class="post-feedback-actions" style="display:none; text-align:center; margin-top:1rem;">
          <button class="start-new-chat" id="startNewChat">Start New Chat</button>
        </div>
      </div>
    </div>
    <!-- Add name prompt dialog -->
    <div id="namePrompt" class="call-back" style="display:none;">
      <label for="userName">Please enter your name:</label>
      <div class="input-row">
        <input type="text" id="userName" required />
        <button type="button" id="submitName">Start Chat</button>
      </div>
    </div>
    <div class="agent-banner" id="agentBanner" style="display:none">
      <div class="agent-avatar" aria-hidden="true">SM</div>
      <div>
        <span id="agentName">Sarah Murphy</span><br>
        <span style="font-size:0.95em; color:#22223b;">Senior Support Specialist</span><br>
        <span style="font-size:0.95em; color:#2563eb;">ETA: <span id="agentEta">2 minutes</span></span>
      </div>
    </div>
    <div class="chat-log" id="chatLog" aria-live="polite"></div>
    <form class="input-row" id="chatForm" autocomplete="off">
      <input type="text" id="userInput" placeholder="Type your message…" aria-label="Type your message" required />
      <button type="submit">Send</button>
    </form>
    <div class="call-back" id="callBack">
      <label for="callbackType">How would you like us to call you?</label>
      <div class="callback-options">
        <button id="instantCallBtn" type="button" class="instant-call">Call Me Now</button>
        <div class="or-divider">or</div>
        <div>
          <label for="timeSlot">Schedule for later:</label>
          <select id="timeSlot" aria-label="Select a time slot">
            <option value="09:00-09:30">09:00–09:30</option>
            <option value="10:00-10:30">10:00–10:30</option>
            <option value="11:00-11:30">11:00–11:30</option>
          </select>
          <button id="callMeBackBtn" type="button">Schedule Call</button>
        </div>
      </div>
      <div class="callback-note">
        All callbacks are handled by verified Revolut support specialists
      </div>
    </div>
    <div class="audit-trail" id="auditTrail" aria-label="Audit trail">
      <button class="export-button" id="exportBtn" title="Download chat history">
        📥 Export Chat History
      </button>
    </div>
    <button class="exit-chat" id="exitChatBtn" aria-label="Exit Chat">
      🚪 Exit Chat
    </button>
  </div>
  <button class="always-human" id="humanBtn">Connect with Human Agent</button>

  <script>
    // Clear localStorage on page load
    localStorage.removeItem('revolut_support_history');
    
    // Get DOM elements
    const namePrompt = document.getElementById('namePrompt');
    const userName = document.getElementById('userName');
    const submitName = document.getElementById('submitName');
    const supportContainer = document.getElementById('supportContainer');
    const exitChatBtn = document.getElementById('exitChatBtn');
    const feedbackModal = document.getElementById('feedbackModal');
    const submitFeedbackBtn = document.getElementById('submitFeedbackBtn');
    const cancelFeedbackBtn = document.getElementById('cancelFeedbackBtn');
    const ratingBtns = document.querySelectorAll('.rating-btn');
    const feedbackEmail = document.getElementById('feedbackEmail');
    
    // Show name prompt first, hide other elements
    document.querySelectorAll('#chatForm, #callBack, #auditTrail, #humanBtn, #agentBanner').forEach(el => {
      el.style.display = 'none';
    });
    namePrompt.style.display = 'block';
    
    // Handle name submission
    submitName.addEventListener('click', () => {
      const name = userName.value.trim();
      if (!name) return;
      
      // Show chat interface
      document.querySelectorAll('#chatForm, #callBack, #auditTrail, #humanBtn').forEach(el => {
        el.style.display = '';
      });
      namePrompt.style.display = 'none';
      
      // Initialize chat with personalized banking-focused greeting
      history = [{
        type: 'agent',
        text: `Hello ${name}, welcome to Revolut Customer Support! 👋\n\nI can help you with:\n• Account issues\n• Card payments\n• International transfers\n• Security concerns\n• App troubleshooting\n\nYou can reach a human specialist anytime by clicking the blue "Connect with Human Agent" button below. What would you like help with today?`,
        time: Date.now()
      }];
      saveHistory(history);
      renderChat(history);
      renderAudit(history);
    });

    // Banking-specific glossary terms
    const glossary = {
      'chargeback': 'A refund initiated by your bank for a disputed transaction',
      'scam': 'A fraudulent scheme to steal money or information',
      'escalate': 'Transfer your case to a human support agent',
      'SEPA': 'Single Euro Payments Area - for European transfers',
      'SWIFT': 'International bank transfer system',
      'interchange': 'Fee charged for card transactions between banks',
      'metal card': 'Revolut\'s premium metal card with exclusive benefits',
      'PIN': 'Personal Identification Number for card security',
      'exchange rate': 'The rate at which one currency converts to another',
      'freeze card': 'Temporarily disable your card for security'
    };

    // Calm mode toggle
    const calmToggle = document.getElementById('calmToggle');
    calmToggle.addEventListener('click', () => {
      document.body.classList.toggle('calm-mode');
      calmToggle.textContent = document.body.classList.contains('calm-mode') ? 'Normal Mode' : 'Calm Mode';
    });

    // Chat and escalation logic
    const chatLog = document.getElementById('chatLog');
    const chatForm = document.getElementById('chatForm');
    const userInput = document.getElementById('userInput');
    const auditTrail = document.getElementById('auditTrail');
    const progress = document.getElementById('progress');
    const humanBtn = document.getElementById('humanBtn');
    const callMeBackBtn = document.getElementById('callMeBackBtn');
    const timeSlot = document.getElementById('timeSlot');

    // Banking and distress keywords for NLP simulation
    const distressWords = [
      'scam', 'panic', 'not working', 'fraud', 'stolen', 'emergency',
      'unauthorized', 'transaction', 'missing money', 'wrong transfer',
      'account blocked', 'payment failed', 'card declined', 'urgent transfer'
    ];

    // Agent details
    const agent = {
      name: 'Sarah Murphy',
      role: 'Senior Banking Specialist',
      eta: '2 minutes'
    };

    // LocalStorage chat history
    function saveHistory(history) {
      localStorage.setItem('revolut_support_history', JSON.stringify(history));
    }
    function loadHistory() {
      return JSON.parse(localStorage.getItem('revolut_support_history') || '[]');
    }

    // Render glossary tooltips
    function renderGlossary(text) {
      return text.replace(/\b(chargeback|scam|escalate)\b/gi, (match) => {
        const key = match.toLowerCase();
        if (glossary[key]) {
          return `<span class="glossary" tabindex="0">${match}<span class="glossary-tooltip">${glossary[key]}</span></span>`;
        }
        return match;
      });
    }

    // Render chat log
    function renderChat(history) {
      chatLog.innerHTML = history.map(entry => {
        let cls = 'chat-entry';
        if (entry.type === 'agent') cls += ' agent';
        if (entry.type === 'user') cls += ' user';
        if (entry.escalated) cls += ' escalated';
        if (entry.isConfirmation) cls += ' isConfirmation';
        return `<div class="${cls}">${renderGlossary(entry.text)}</div>`;
      }).join('');
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    // Render audit trail
    function renderAudit(history) {
      auditTrail.innerHTML = history.map(entry => {
        const time = new Date(entry.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        return `<div>[${time}] ${entry.type === 'user' ? 'You' : 'Support'}: ${entry.text}</div>`;
      }).join('');
    }

    // Show agent banner
    function showAgentBanner(show = true) {
      document.getElementById('agentBanner').style.display = show ? '' : 'none';
    }

    // Escalate to human
    function escalate(history, reason) {
      showAgentBanner(true);
      const name = userName.value.trim();
      history.push({
        type: 'agent',
        text: `Thank you for your patience, ${name}. A real person is reviewing this now.\n\n<b><span aria-label="Agent">You will be connected to <span style='color:#2563eb'>${agent.name}</span> (${agent.role})</span></b>. ETA: <b>${agent.eta}</b>.\n\nWe understand this might be concerning, and we're here to help. Your case is our priority.` + (reason ? `<br><span style='color:var(--danger)'>Escalated due to: "${reason}"</span>` : ''),
        time: Date.now(),
        escalated: true
      });
      progress.textContent = 'Step 2 of 2: Human Support';
      saveHistory(history);
      renderChat(history);
      renderAudit(history);
    }

    // NLP simulation for distress
    function checkDistress(text) {
      const found = distressWords.find(word => text.toLowerCase().includes(word));
      return found || null;
    }

    // Initial load
    let history = loadHistory();
    if (history.length === 0) {
      // Don't initialize with any messages, wait for name input
      history = [];
      saveHistory(history);
    }
    // Show agent banner if last message is escalated
    if (history.some(h => h.escalated)) showAgentBanner(true);
    renderChat(history);
    renderAudit(history);

    // Chat form submit
    chatForm.addEventListener('submit', e => {
      e.preventDefault();
      const text = userInput.value.trim();
      if (!text) return;
      history.push({ type: 'user', text, time: Date.now() });
      saveHistory(history);
      renderChat(history);
      renderAudit(history);
      userInput.value = '';
      // NLP escalation
      const distress = checkDistress(text);
      if (distress) {
        escalate(history, distress);
      }
    });

    // Always-visible human button
    humanBtn.addEventListener('click', () => {
      escalate(history);
    });

    // Call Me Back
    callMeBackBtn.addEventListener('click', () => {
      const slot = timeSlot.value;
      history.push({
        type: 'agent',
        text: `We’ll call you back at your chosen time slot: <b>${slot}</b>.`,
        time: Date.now()
      });
      saveHistory(history);
      renderChat(history);
      renderAudit(history);
    });

    // Export chat history
    document.getElementById('exportBtn').addEventListener('click', () => {
      const history = loadHistory();
      const exportData = history.map(entry => {
        const time = new Date(entry.time).toLocaleString();
        return `[${time}] ${entry.type === 'user' ? 'You' : 'Support'}: ${entry.text}`;
      }).join('\n');
      
      const blob = new Blob([exportData], { type: 'text/plain' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'revolut-chat-history.txt';
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
    });

    // Instant callback handler
    document.getElementById('instantCallBtn').addEventListener('click', () => {
      const name = userName.value.trim();
      history.push({
        type: 'agent',
        text: `We're initiating an immediate callback to you now. One of our verified support specialists will call you within the next 5 minutes.`,
        time: Date.now()
      });
      saveHistory(history);
      renderChat(history);
      renderAudit(history);
    });

    // Submit name and start chat
    submitName.addEventListener('click', () => {
      const name = userName.value.trim();
      if (!name) return;
      // Update agent message with user name
      const welcomeMessage = `Hello ${name}! How can we help you today? If you need urgent help, just type or click "Speak to a Human".`;
      let history = loadHistory();
      history.push({ type: 'agent', text: welcomeMessage, time: Date.now() });
      saveHistory(history);
      renderChat(history);
      renderAudit(history);
      // Hide name prompt and show chat
      namePrompt.style.display = 'none';
      document.getElementById('agentBanner').style.display = 'none';
      document.getElementById('progress').style.display = 'block';
      document.getElementById('chatForm').style.display = 'flex';
      document.getElementById('callBack').style.display = 'block';
    });

    // Show name prompt on initial load
    window.addEventListener('load', () => {
      // Check if user name is already saved
      const savedName = localStorage.getItem('revolut_user_name');
      if (savedName) {
        userName.value = savedName;
        // Automatically start chat if name is saved
        submitName.click();
      } else {
        namePrompt.style.display = 'block';
      }
    });

    // Exit chat and feedback handling
    const exitChat = document.getElementById('exitChatBtn');
    const cancelFeedback = document.getElementById('cancelFeedback');
    const submitFeedback = document.getElementById('submitFeedback');
    const emailInput = document.getElementById('emailInput');
    const startNewChat = document.getElementById('startNewChat');
    let selectedRating = 0;

    // Generate a unique ticket number
    function generateTicketNumber() {
      const date = new Date();
      const timestamp = date.getTime().toString().slice(-6);
      return `REV-${timestamp}`;
    }

    exitChat.addEventListener('click', () => {
      feedbackModal.style.display = 'flex';
      document.querySelector('.ticket-number').textContent = `Your reference number: ${generateTicketNumber()}`;
    });

    cancelFeedback.addEventListener('click', () => {
      feedbackModal.style.display = 'none';
    });

    document.querySelectorAll('.rating-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        document.querySelectorAll('.rating-btn').forEach(b => b.style.background = '#f1f5f9');
        e.target.style.background = '#e3f6f5';
        selectedRating = parseInt(e.target.dataset.rating);
      });
    });

    submitFeedback.addEventListener('click', () => {
      const email = emailInput.value.trim();
      const history = loadHistory();
      const ticketNumber = generateTicketNumber();
      
      // Add end chat message to history
      history.push({
        type: 'agent',
        text: `🎯 Thank you for contacting Revolut support!\n\nYour chat reference number: ${ticketNumber}\n\n${email ? 'We\'ll send your chat summary to ' + email : 'You can export your chat history using the button below'}`,
        time: Date.now(),
        isConfirmation: true
      });
      
      saveHistory(history);
      renderChat(history);
      renderAudit(history);
      
      // Update feedback modal
      document.querySelector('.feedback-actions').style.display = 'none';
      document.querySelector('.post-feedback-actions').style.display = 'block';
      document.querySelector('.rating-buttons').style.display = 'none';
      document.querySelector('.email-input').style.display = 'none';
      document.querySelector('.feedback-content h2').textContent = 'Thank You!';
      document.querySelector('.feedback-content p').textContent = 
        'Your feedback helps us improve our service. You can start a new chat or exit now.';
    });

    // Start new chat handler
    startNewChat.addEventListener('click', () => {
      // Clear history and reset UI
      localStorage.removeItem('revolut_support_history');
      history = [];
      saveHistory(history);
      
      // Reset feedback modal
      feedbackModal.style.display = 'none';
      document.querySelector('.feedback-actions').style.display = 'flex';
      document.querySelector('.post-feedback-actions').style.display = 'none';
      document.querySelector('.rating-buttons').style.display = 'flex';
      document.querySelector('.email-input').style.display = 'block';
      document.querySelector('.feedback-content h2').textContent = 'Before You Go';
      
      // Show name prompt for new chat
      namePrompt.style.display = 'block';
      document.querySelectorAll('#chatForm, #callBack, #auditTrail, #humanBtn, #agentBanner').forEach(el => {
        el.style.display = 'none';
      });
      
      // Clear chat log
      chatLog.innerHTML = '';
      auditTrail.innerHTML = '';
      userInput.value = '';
      userName.value = '';
    });

    // Helper function for confirmation messages
    function showConfirmation(message) {
      history.push({
        type: 'agent',
        text: `✓ ${message}`,
        time: Date.now(),
        isConfirmation: true
      });
      saveHistory(history);
      renderChat(history);
      renderAudit(history);
    }
  </script>
</body>
</html>
